{
 'Реквизиты': {
  'Код': '000000004',
  'Наименование': 'Уведомление пользователей о новых комментариях',
  'ТекстОбработки': 'Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	DT_УведомлениеПоОбъектам.Объект КАК Объект,
	|	DT_УведомлениеПоОбъектам.ТипУведомления КАК ТипУведомления,
	|	DT_УведомлениеПоОбъектам.Пользователь КАК Пользователь,
	|	DT_УведомлениеПоОбъектам.Текст КАК Текст,
	|	DT_УведомлениеПоОбъектам.КоличествоПопыток КАК КоличествоПопыток
	|ИЗ
	|	РегистрСведений.DT_УведомлениеПоОбъектам КАК DT_УведомлениеПоОбъектам
	|ГДЕ
	|	DT_УведомлениеПоОбъектам.КоличествоПопыток < 3
	|	И DT_УведомлениеПоОбъектам.ТипУведомления = Значение(Перечисление.DT_ТипыУведомлений.ПоПочте)");   
УстановитьПривелигированныйРежим(Истина);
Выборка = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);       
УстановитьПривелигированныйРежим(Ложь);

Пока Выборка.Следующий() Цикл

	Отправлено = Ложь;
	
	ПочтовыйАдресПолучателя = DT_ОбщегоНазначения.АдресЭлектроннойПочты(Выборка.Пользователь);
	Если ПустаяСтрока(ПочтовыйАдресПолучателя) Тогда
		ЗаписьЖурналаРегистрации(НСтр("ru = \u0027Уведомления пользователям\u0027",
			ОбщегоНазначения.КодОсновногоЯзыка()), 
			УровеньЖурналаРегистрации.Информация,,,
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = \u0027Уведомление не отправлено, так как не указан почтовый адрес у пользователя %1.\u0027"), Строка(Выборка.Пользователь)));
	Иначе
			
		ТекстПисьма = "Новые комментарии в " + Выборка.Объект +
						Символы.ПС +
						Символы.ПС +
						Выборка.Текст;
		
		ПараметрыПисьма = Новый Структура;
		ПараметрыПисьма.Вставить("Тема", "Уведомление по " + Выборка.Объект);
		ПараметрыПисьма.Вставить("Тело", ТекстПисьма);
		ПараметрыПисьма.Вставить("Кому", ПочтовыйАдресПолучателя);
		
		МодульРаботаСПочтовымиСообщениями = ОбщегоНазначения.ОбщийМодуль("РаботаСПочтовымиСообщениями");
		Попытка 
			УчетнаяЗапись = МодульРаботаСПочтовымиСообщениями.СистемнаяУчетнаяЗапись();
			Письмо = МодульРаботаСПочтовымиСообщениями.ПодготовитьПисьмо(УчетнаяЗапись, ПараметрыПисьма);
			МодульРаботаСПочтовымиСообщениями.ОтправитьПисьмо(УчетнаяЗапись, Письмо);
			Отправлено = Истина;
		Исключение
			ЗаписьЖурналаРегистрации(НСтр("ru = \u0027Уведомления пользователям\u0027",
				ОбщегоНазначения.КодОсновногоЯзыка()), 
				УровеньЖурналаРегистрации.Ошибка,,,
				СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = \u0027Ошибка при отправке уведомления о новых комментариях: %1\u0027"), 
				   ПодробноеПредставлениеОшибки(ИнформацияОбОшибке())));
		КонецПопытки;
	КонецЕсли;
	
	Если Отправлено Тогда
		НаборЗаписей = РегистрыСведений.DT_УведомлениеПоОбъектам.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Объект.Установить(Выборка.Объект);
		НаборЗаписей.Отбор.ТипУведомления.Установить(Выборка.ТипУведомления);
		НаборЗаписей.Отбор.Пользователь.Установить(Выборка.Пользователь);
		НаборЗаписей.Записать();
	Иначе
		Запись = РегистрыСведений.DT_УведомлениеПоОбъектам.СоздатьМенеджерЗаписи();
		Запись.Объект 			= Выборка.Объект;
		Запись.ТипУведомления 	= Выборка.ТипУведомления;
		Запись.Пользователь 	= Выборка.Пользователь;
		Запись.Прочитать();
		Если Запись.Выбран() Тогда
			Запись.КоличествоПопыток = Запись.КоличествоПопыток + 1;
			Запись.Записать();
		КонецЕсли;
	КонецЕсли;
		
КонецЦикла;',
  'Комментарий': ''
 },
 'ТЧ': [
  {
   'Переменные': []
  }
 ]
}
